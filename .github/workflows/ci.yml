name: ğŸš€ CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================
  # ğŸ¨ Code Quality Checks
  # ============================================
  quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ¨ Run ESLint
        working-directory: ./frontend
        run: |
          echo "ğŸ¨ Running ESLint..."
          npm run lint
          echo "âœ… Linting complete!"

      - name: ğŸ” TypeScript Check
        working-directory: ./frontend
        run: |
          echo "ğŸ” Checking TypeScript..."
          npm run type-check
          echo "âœ… Type checking passed!"

      - name: ğŸ“Š Code Quality Report
        if: always()
        run: |
          echo "ğŸ“Š Code Quality Summary"
          echo "========================"
          echo "âœ… ESLint: Checked"
          echo "âœ… TypeScript: Valid"
          echo "âœ… Ready for testing"

  # ============================================
  # ğŸ§ª Unit Tests
  # ============================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ§ª Run Unit Tests
        working-directory: ./frontend
        run: |
          echo "ğŸ§ª Running unit tests..."
          npm run test:ci
          echo "âœ… Unit tests complete!"

      - name: ğŸ“Š Test Summary
        if: always()
        run: |
          echo "ğŸ“Š Unit Test Summary"
          echo "===================="
          echo "âœ… Tests executed"
          echo "ğŸ“ˆ Coverage generated"

  # ============================================
  # ğŸ­ E2E Tests
  # ============================================
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    needs: quality
    services:
      docker:
        image: docker:dind
        options: --privileged
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ³ Start Services
        run: |
          echo "ğŸ³ Starting Docker services..."
          docker compose up -d
          echo "â³ Waiting for services to be ready..."
          sleep 30
          echo "âœ… Services are up!"

      - name: ğŸ“¦ Install Cypress
        working-directory: ./frontend
        run: |
          npm ci
          npx cypress install

      - name: ğŸ­ Run E2E Tests
        working-directory: ./frontend
        run: |
          echo "ğŸ­ Running E2E tests..."
          npm run test:e2e:headless
          echo "âœ… E2E tests complete!"

      - name: ğŸ“¸ Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots

      - name: ğŸ¥ Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos

      - name: ğŸ§¹ Cleanup
        if: always()
        run: docker compose down

  # ============================================
  # ğŸ—ï¸ Build & Bundle Analysis
  # ============================================
  build:
    name: ğŸ—ï¸ Build & Analyze
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ—ï¸ Build Application
        working-directory: ./frontend
        run: |
          echo "ğŸ—ï¸ Building production bundle..."
          npm run build
          echo "âœ… Build successful!"

      - name: ğŸ“Š Bundle Analysis
        working-directory: ./frontend
        run: |
          echo "ğŸ“Š Bundle Analysis"
          echo "=================="
          echo "ğŸ“¦ Build Output:"
          du -sh .next/
          echo ""
          echo "ğŸ“ˆ Static Assets:"
          find .next/static -type f -name "*.js" | wc -l
          echo "JavaScript files"
          find .next/static -type f -name "*.css" | wc -l
          echo "CSS files"

      - name: ğŸš€ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: frontend/.next/

  # ============================================
  # ğŸ³ Docker Build
  # ============================================
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker Images
        run: |
          echo "ğŸ³ Building Docker images..."
          docker compose build --no-cache
          echo "âœ… Docker images built!"

      - name: ğŸ” Image Analysis
        run: |
          echo "ğŸ” Docker Image Analysis"
          echo "========================"
          docker images | grep -E "fridgr|mock-backend"
          echo ""
          echo "ğŸ“Š Image sizes:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "fridgr|mock-backend"

  # ============================================
  # ğŸ“ˆ Final Report
  # ============================================
  report:
    name: ğŸ“ˆ Pipeline Report
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, e2e-tests, build, docker]
    if: always()
    steps:
      - name: ğŸ“Š Generate Final Report
        env:
          QUALITY_STATUS: ${{ needs.quality.result }}
          UNIT_STATUS: ${{ needs.unit-tests.result }}
          E2E_STATUS: ${{ needs.e2e-tests.result }}
          BUILD_STATUS: ${{ needs.build.result }}
          DOCKER_STATUS: ${{ needs.docker.result }}
        run: |
          echo "========================================="
          echo "ğŸš€ FRIDGR CI PIPELINE REPORT"
          echo "========================================="
          echo ""
          
          # Function to get emoji based on status
          get_status_emoji() {
            if [ "$1" == "success" ]; then
              echo "âœ… Passed"
            elif [ "$1" == "failure" ]; then
              echo "âŒ Failed"
            elif [ "$1" == "skipped" ]; then
              echo "â­ï¸ Skipped"
            else
              echo "âš ï¸ Unknown"
            fi
          }
          
          # Display status for each job
          echo "ğŸ“‹ Code Quality:       $(get_status_emoji $QUALITY_STATUS)"
          echo "ğŸ§ª Unit Tests:         $(get_status_emoji $UNIT_STATUS)"
          echo "ğŸ­ E2E Tests:          $(get_status_emoji $E2E_STATUS)"
          echo "ğŸ—ï¸ Build:              $(get_status_emoji $BUILD_STATUS)"
          echo "ğŸ³ Docker:             $(get_status_emoji $DOCKER_STATUS)"
          echo ""
          echo "========================================="
          
          # Check if all tests passed
          if [ "$QUALITY_STATUS" == "success" ] && \
             [ "$UNIT_STATUS" == "success" ] && \
             [ "$E2E_STATUS" == "success" ] && \
             [ "$BUILD_STATUS" == "success" ] && \
             [ "$DOCKER_STATUS" == "success" ]; then
            echo "ğŸ‰ MVP READY FOR DEPLOYMENT!"
            echo "========================================="
            echo ""
            echo "ğŸ“¦ Artifacts Available:"
            echo "  - Build output"
            echo "  - Test reports"
            echo "  - Docker images"
            echo ""
            echo "ğŸš€ Next Steps:"
            echo "  1. Review PR"
            echo "  2. Approve deployment"
            echo "  3. Ship to production!"
          else
            echo "âš ï¸ PIPELINE FAILED - REVIEW REQUIRED"
            echo "========================================="
            echo ""
            echo "â— Failed Jobs:"
            [ "$QUALITY_STATUS" != "success" ] && echo "  - Code Quality"
            [ "$UNIT_STATUS" != "success" ] && echo "  - Unit Tests"
            [ "$E2E_STATUS" != "success" ] && echo "  - E2E Tests"
            [ "$BUILD_STATUS" != "success" ] && echo "  - Build"
            [ "$DOCKER_STATUS" != "success" ] && echo "  - Docker"
            echo ""
            echo "ğŸ“Œ Next Steps:"
            echo "  1. Review failed job logs"
            echo "  2. Fix identified issues"
            echo "  3. Push fixes and re-run pipeline"
          fi
          
          echo ""
          echo "Built with â¤ï¸ by Fridgr Team"
          
          # Exit with failure if any job failed
          if [ "$QUALITY_STATUS" != "success" ] || \
             [ "$UNIT_STATUS" != "success" ] || \
             [ "$E2E_STATUS" != "success" ] || \
             [ "$BUILD_STATUS" != "success" ] || \
             [ "$DOCKER_STATUS" != "success" ]; then
            exit 1
          fi