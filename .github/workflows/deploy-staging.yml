name: Build and Push Staging Artifacts

# Trigger on push to main branch
on:
  push:
    branches:
      - main

# Environment variables
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # Job to build and push Docker images to GitHub Container Registry
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    # Set permissions for the GITHUB_TOKEN
    permissions:
      contents: read
      packages: write
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Docker Buildx for advanced build features
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Step 3: Log in to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 4: Extract metadata for Docker images
      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=staging,enable={{is_default_branch}}
      
      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=staging,enable={{is_default_branch}}
      
      # Step 5: Build and push Frontend Docker image
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.pantrybot.app/api/v1
            NEXT_PUBLIC_WS_URL=wss://api.pantrybot.app/ws
            NEXT_PUBLIC_APP_URL=https://pantrybot.app
      
      # Step 6: Build and push Backend Docker image
      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PORT=8088
            NODE_ENV=production
      
      # Step 7: Create artifact summary
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Staging Artifacts Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images Published to ghcr.io:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Frontend Image:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-frontend.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Backend Image:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta-backend.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into the staging VPS" >> $GITHUB_STEP_SUMMARY
          echo "2. Navigate to the project directory" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`./scripts/deploy.sh\` to deploy the new images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Commit: ${{ github.sha }}_" >> $GITHUB_STEP_SUMMARY
          echo "_Branch: ${{ github.ref_name }}_" >> $GITHUB_STEP_SUMMARY
          echo "_Triggered by: ${{ github.actor }}_" >> $GITHUB_STEP_SUMMARY

# IMPORTANT: This workflow ONLY builds and pushes Docker images to ghcr.io
# It does NOT contain any deployment steps, SSH actions, or server interactions
# Manual deployment must be performed using the scripts/deploy.sh script on the VPS